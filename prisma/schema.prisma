// ============================================
// Core Modules - Prisma Schema
// Database: MySQL
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT MODULE
// ============================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  firstName         String?
  lastName          String?
  phone             String?
  avatar            String?
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  lastLoginAt       DateTime?
  metadata          Json?     // Flexible custom fields

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete

  // Relations
  roles             UserRole[]
  apiKeys           ApiKey[]
  sessions          Session[]
  passwordResets    PasswordReset[]
  addresses         Address[]

  // Cross-module relations (optional)
  orders            Order[]
  carts             Cart[]
  payments          Payment[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) // System roles can't be deleted
  metadata    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissions RolePermission[]
  users       UserRole[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique  // e.g., "users.create", "orders.read"
  description String?
  module      String   // e.g., "users", "orders", "payments"
  action      String   // e.g., "create", "read", "update", "delete"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  roles       RolePermission[]

  @@unique([module, action])
  @@index([module])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String

  createdAt    DateTime @default(now())

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String
  name        String
  key         String    @unique
  secret      String    // Hashed
  scopes      Json      // Array of permission scopes
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([userId])
  @@map("api_keys")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique @db.VarChar(500)
  refreshToken String?  @unique @db.VarChar(500)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_resets")
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  type         String   @default("shipping") // shipping, billing
  isDefault    Boolean  @default(false)
  firstName    String
  lastName     String
  company      String?
  address1     String
  address2     String?
  city         String
  state        String?
  postalCode   String
  country      String
  phone        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

// ============================================
// PRODUCT MANAGEMENT MODULE
// ============================================

model Product {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  status      String   @default("draft") // draft, active, archived
  metadata    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relations
  variants    ProductVariant[]
  categories  ProductCategory[]
  images      ProductImage[]

  @@index([slug])
  @@index([status])
  @@map("products")
}

model ProductVariant {
  id           String   @id @default(uuid())
  productId    String
  sku          String   @unique
  name         String
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  cost         Decimal? @db.Decimal(10, 2)
  quantity     Int      @default(0)
  weight       Decimal? @db.Decimal(10, 3)
  options      Json?    // { color: "red", size: "M" }
  isDefault    Boolean  @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems    CartItem[]
  orderItems   OrderItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  parentId    String?
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryParent")
  products    ProductCategory[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model ProductCategory {
  id         String   @id @default(uuid())
  productId  String
  categoryId String

  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@map("product_categories")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  url       String
  alt       String?
  sortOrder Int      @default(0)

  createdAt DateTime @default(now())

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ============================================
// CART MANAGEMENT MODULE
// ============================================

model Cart {
  id          String    @id @default(uuid())
  userId      String?
  sessionId   String?   // For guest carts
  status      String    @default("active") // active, converted, abandoned
  currency    String    @default("USD")
  metadata    Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime?

  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  items       CartItem[]
  discounts   CartDiscount[]

  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@map("carts")
}

model CartItem {
  id         String   @id @default(uuid())
  cartId     String
  variantId  String
  quantity   Int      @default(1)
  price      Decimal  @db.Decimal(10, 2)
  metadata   Json?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  cart       Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant    ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
  @@map("cart_items")
}

model CartDiscount {
  id         String   @id @default(uuid())
  cartId     String
  discountId String

  createdAt  DateTime @default(now())

  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  discount   Discount @relation(fields: [discountId], references: [id])

  @@unique([cartId, discountId])
  @@map("cart_discounts")
}

// ============================================
// ORDER MANAGEMENT MODULE
// ============================================

model Order {
  id              String    @id @default(uuid())
  orderNumber     String    @unique
  userId          String?
  email           String
  status          String    @default("pending") // pending, confirmed, processing, shipped, delivered, cancelled
  paymentStatus   String    @default("pending") // pending, paid, refunded, failed
  fulfillmentStatus String  @default("unfulfilled") // unfulfilled, partial, fulfilled

  // Pricing
  subtotal        Decimal   @db.Decimal(10, 2)
  discount        Decimal   @default(0) @db.Decimal(10, 2)
  tax             Decimal   @default(0) @db.Decimal(10, 2)
  shipping        Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")

  // Addresses (stored as JSON for history)
  shippingAddress Json
  billingAddress  Json?

  // Metadata
  notes           String?   @db.Text
  metadata        Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  cancelledAt     DateTime?

  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  payments        Payment[]
  fulfillments    Fulfillment[]
  events          OrderEvent[]

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String
  variantId       String?
  productName     String
  variantName     String?
  sku             String?
  quantity        Int
  price           Decimal  @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  fulfilledQty    Int      @default(0)
  metadata        Json?

  createdAt       DateTime @default(now())

  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  fulfillmentItems FulfillmentItem[]

  @@index([orderId])
  @@map("order_items")
}

model OrderEvent {
  id        String   @id @default(uuid())
  orderId   String
  type      String   // status_changed, payment_received, shipped, etc.
  data      Json?
  note      String?
  createdBy String?

  createdAt DateTime @default(now())

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([type])
  @@map("order_events")
}

// ============================================
// PAYMENT MANAGEMENT MODULE
// ============================================

model Payment {
  id              String    @id @default(uuid())
  orderId         String
  userId          String?
  providerId      String
  providerPaymentId String?
  amount          Decimal   @db.Decimal(10, 2)
  currency        String
  status          String    @default("pending") // pending, processing, completed, failed, refunded
  method          String?   // card, paypal, bank_transfer
  metadata        Json?

  paidAt          DateTime?
  refundedAt      DateTime?
  failedAt        DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  provider        PaymentProvider @relation(fields: [providerId], references: [id])
  refunds         Refund[]

  @@index([orderId])
  @@index([userId])
  @@index([providerPaymentId])
  @@index([status])
  @@map("payments")
}

model PaymentProvider {
  id            String   @id @default(uuid())
  name          String
  code          String   @unique // stripe, paypal, manual
  isActive      Boolean  @default(true)
  config        Json?    // Provider-specific configuration

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  payments      Payment[]

  @@map("payment_providers")
}

model Refund {
  id        String   @id @default(uuid())
  paymentId String
  amount    Decimal  @db.Decimal(10, 2)
  reason    String?
  status    String   @default("pending") // pending, completed, failed
  metadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@map("refunds")
}

// ============================================
// FULFILLMENT MANAGEMENT MODULE
// ============================================

model Fulfillment {
  id              String    @id @default(uuid())
  orderId         String
  providerId      String?
  trackingNumber  String?
  trackingUrl     String?
  carrier         String?
  status          String    @default("pending") // pending, shipped, in_transit, delivered, failed
  shippedAt       DateTime?
  deliveredAt     DateTime?
  metadata        Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider        ShippingProvider? @relation(fields: [providerId], references: [id])
  items           FulfillmentItem[]

  @@index([orderId])
  @@index([trackingNumber])
  @@map("fulfillments")
}

model FulfillmentItem {
  id            String   @id @default(uuid())
  fulfillmentId String
  orderItemId   String
  quantity      Int

  createdAt     DateTime @default(now())

  fulfillment   Fulfillment @relation(fields: [fulfillmentId], references: [id], onDelete: Cascade)
  orderItem     OrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("fulfillment_items")
}

model ShippingProvider {
  id            String   @id @default(uuid())
  name          String
  code          String   @unique // shippo, shipengine, manual
  isActive      Boolean  @default(true)
  config        Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  fulfillments  Fulfillment[]

  @@map("shipping_providers")
}

// ============================================
// DISCOUNT MANAGEMENT MODULE
// ============================================

model Discount {
  id            String    @id @default(uuid())
  code          String    @unique
  description   String?
  type          String    // percentage, fixed_amount, free_shipping
  value         Decimal   @db.Decimal(10, 2)
  minPurchase   Decimal?  @db.Decimal(10, 2)
  maxUses       Int?
  usedCount     Int       @default(0)
  startsAt      DateTime?
  endsAt        DateTime?
  isActive      Boolean   @default(true)
  metadata      Json?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  carts         CartDiscount[]
  conditions    DiscountCondition[]

  @@index([code])
  @@index([isActive])
  @@map("discounts")
}

model DiscountCondition {
  id          String   @id @default(uuid())
  discountId  String
  type        String   // product, category, customer, min_quantity
  operator    String   // in, not_in, equals, gte, lte
  value       Json     // IDs or values based on type

  createdAt   DateTime @default(now())

  discount    Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@index([discountId])
  @@map("discount_conditions")
}

// ============================================
// NOTIFICATION MANAGEMENT MODULE
// ============================================

model Notification {
  id          String    @id @default(uuid())
  type        String    // email, sms, push
  recipient   String
  subject     String?
  content     String    @db.Text
  status      String    @default("pending") // pending, sent, failed
  sentAt      DateTime?
  failedAt    DateTime?
  error       String?
  metadata    Json?

  createdAt   DateTime  @default(now())

  @@index([type])
  @@index([status])
  @@index([recipient])
  @@map("notifications")
}

model NotificationTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  type        String   // email, sms
  subject     String?
  content     String   @db.Text
  variables   Json?    // Available template variables
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notification_templates")
}

// ============================================
// REGION MANAGEMENT MODULE
// ============================================

model Region {
  id            String   @id @default(uuid())
  name          String
  code          String   @unique
  currency      String   @default("USD")
  taxRate       Decimal  @default(0) @db.Decimal(5, 4)
  isActive      Boolean  @default(true)
  metadata      Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  countries     Country[]

  @@map("regions")
}

model Country {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique // ISO 3166-1 alpha-2
  regionId  String?

  region    Region?  @relation(fields: [regionId], references: [id], onDelete: SetNull)

  @@map("countries")
}

model Currency {
  id        String   @id @default(uuid())
  code      String   @unique // ISO 4217
  name      String
  symbol    String
  decimals  Int      @default(2)
  isActive  Boolean  @default(true)

  @@map("currencies")
}

// ============================================
// WEBHOOK MANAGEMENT (Cross-module)
// ============================================

model Webhook {
  id          String    @id @default(uuid())
  url         String
  secret      String
  events      Json      // Array of event names
  isActive    Boolean   @default(true)
  failCount   Int       @default(0)
  lastSuccess DateTime?
  lastFailure DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("webhooks")
}

model WebhookEvent {
  id          String    @id @default(uuid())
  webhookId   String
  event       String
  payload     Json
  status      String    @default("pending") // pending, sent, failed
  attempts    Int       @default(0)
  response    Json?
  sentAt      DateTime?

  createdAt   DateTime  @default(now())

  @@index([webhookId])
  @@index([status])
  @@map("webhook_events")
}
